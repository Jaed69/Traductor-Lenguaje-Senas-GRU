name: ğŸš€ LSP Data Collector CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: ğŸ§ª Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11', '3.12']

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov black flake8

    - name: ğŸ¨ Code Style Check
      run: |
        black --check --diff .
        flake8 . --max-line-length=88 --extend-ignore=E203,W503

    - name: ğŸ§ª Run Tests
      run: |
        pytest --cov=. --cov-report=xml

    - name: ğŸ“Š Upload Coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  performance:
    name: âš¡ Performance Test
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install memory-profiler

    - name: âš¡ Performance Benchmark
      run: |
        python -c "
        import time
        import psutil
        import numpy as np
        from unittest.mock import MagicMock
        
        # Mock MediaPipe for CI environment
        import sys
        from unittest.mock import MagicMock
        sys.modules['mediapipe'] = MagicMock()
        sys.modules['mediapipe.tasks'] = MagicMock()
        sys.modules['mediapipe.tasks.python'] = MagicMock()
        sys.modules['mediapipe.tasks.python.vision'] = MagicMock()
        
        print('âš¡ Starting performance benchmark...')
        start_time = time.time()
        
        # Simulate feature extraction performance
        for i in range(100):
            # Simulate pose processing
            pose_data = np.random.random((33, 3))
            hand_data = np.random.random((21, 3))
            
            # Simulate normalization
            normalized = (pose_data - np.mean(pose_data)) / np.std(pose_data)
            
        end_time = time.time()
        processing_time = end_time - start_time
        
        print(f'ğŸ“Š Processed 100 frames in {processing_time:.2f}s')
        print(f'ğŸ“ˆ Average per frame: {processing_time/100*1000:.2f}ms')
        print(f'ğŸ¯ Target: < 50ms per frame')
        
        if processing_time/100 > 0.05:
            print('âš ï¸  Performance warning: exceeds 50ms target')
        else:
            print('âœ… Performance target met')
        "

  docs:
    name: ğŸ“š Documentation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install sphinx sphinx-rtd-theme

    - name: ğŸ“– Build Documentation
      run: |
        mkdir -p docs
        echo "# ğŸ“š LSP Traductor Documentation" > docs/index.md
        echo "Auto-generated documentation for version ${{ github.sha }}" >> docs/index.md

  release:
    name: ğŸ·ï¸ Release Management
    runs-on: ubuntu-latest
    needs: [test, performance]
    if: github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, '[RELEASE]')

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ·ï¸ Create Release Tag
      run: |
        VERSION=$(date +"%Y.%m.%d")-${GITHUB_SHA::7}
        echo "Creating release tag: v$VERSION"
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git tag -a "v$VERSION" -m "ğŸš€ Automated release v$VERSION"
        git push origin "v$VERSION"

  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ”’ Install Security Tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety

    - name: ğŸ›¡ï¸ Run Security Checks
      run: |
        echo "ğŸ” Running Bandit security scan..."
        bandit -r . -f json -o bandit-report.json || true
        
        echo "ğŸ” Checking for known vulnerabilities..."
        safety check --json --output safety-report.json || true
        
        echo "âœ… Security scan completed"

    - name: ğŸ“Š Upload Security Reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json

  accessibility:
    name: â™¿ Accessibility Check
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: â™¿ Accessibility Validation
      run: |
        echo "â™¿ Checking accessibility considerations..."
        
        # Check for accessibility comments in code
        if grep -r "accessibility\|a11y\|ARIA\|screen.reader" . --include="*.py" --include="*.md"; then
          echo "âœ… Accessibility considerations found"
        else
          echo "âš ï¸  Consider adding accessibility documentation"
        fi
        
        # Check README for accessibility section
        if grep -i "accessibility\|accesibilidad" README.md; then
          echo "âœ… Accessibility documentation present"
        else
          echo "âš ï¸  Consider adding accessibility section to README"
        fi
        
        echo "âœ… Accessibility check completed"

# ğŸ”” Notification Configuration
notifications:
  slack:
    on_success: change
    on_failure: always
  email:
    on_success: never
    on_failure: change
